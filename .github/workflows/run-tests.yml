name: Tests and Coverage

on:
  workflow_dispatch:
  push:
    branches:
      - 'develop'
      - 'feature/**'
      - 'hotfix/**'
      - 'release/**'
      - '!main'
    paths:
      - '.github/workflows/**'
      - 'assets/**'
      - 'devtool/**'
      - 'lang/**'
      - 'lib/**'
      - 'packages/*/src/**'
      - 'packages/*/index.ts'
      - 'scripts/**'
      - 'services/**'
      - 'utils/**'
      - 'tests/**'
      - 'cli.cjs'
      - 'vite.config.ts'
      - 'build-lib-prerelease.yml'


jobs:
  coverage:
    runs-on: ubuntu-latest
    name: Run Vitest Tests and Coverage

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Install test dependencies
        working-directory: ./tests/vitest
        run: |
          rm -rf node_modules package-lock.json
          npm install

      - name: Run tests with coverage
        working-directory: ./tests/vitest
        run: npm run test:coverage

      - name: Generate coverage badge
        working-directory: ./tests/vitest
        run: npm run badge

      - name: Upload badge artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: tests/vitest/coverage/badge.svg

      - name: Post coverage summary
        run: |
          # Build markdown summary
          SUMMARY="## ðŸ“Š Test Results & Coverage Summary\n"

          # Test results
          if [ -f "./tests/vitest/coverage/test-results.json" ]; then
            TOTAL_TESTS=$(jq -r '.numTotalTests // 0' ./tests/vitest/coverage/test-results.json)
            PASSED_TESTS=$(jq -r '.numPassedTests // 0' ./tests/vitest/coverage/test-results.json)
            FAILED_TESTS=$(jq -r '.numFailedTests // 0' ./tests/vitest/coverage/test-results.json)
            TEST_FILES=$(jq -r '.numTotalTestSuites // 0' ./tests/vitest/coverage/test-results.json)

            SUMMARY+="\n### ðŸ§ª Test Results\n"
            SUMMARY+="| Metric | Count |\n"
            SUMMARY+="|--------|-------|\n"
            SUMMARY+="| Total Tests | ${TOTAL_TESTS} |\n"
            SUMMARY+="| Passed | ${PASSED_TESTS} |\n"
            SUMMARY+="| Failed | ${FAILED_TESTS} |\n"
            SUMMARY+="| Test Files | ${TEST_FILES} |\n"
          fi

          # Coverage summary
          if [ -f "./tests/vitest/coverage/coverage-summary.json" ]; then
            LINES=$(jq -r '.total.lines.pct' ./tests/vitest/coverage/coverage-summary.json)
            STATEMENTS=$(jq -r '.total.statements.pct' ./tests/vitest/coverage/coverage-summary.json)
            FUNCTIONS=$(jq -r '.total.functions.pct' ./tests/vitest/coverage/coverage-summary.json)
            BRANCHES=$(jq -r '.total.branches.pct' ./tests/vitest/coverage/coverage-summary.json)

            if (( $(echo "$LINES >= 85" | bc -l) )); then
              COLOR="brightgreen"
            elif (( $(echo "$LINES >= 70" | bc -l) )); then
              COLOR="yellow"
            elif (( $(echo "$LINES >= 50" | bc -l) )); then
              COLOR="orange"
            else
              COLOR="red"
            fi

            SUMMARY+="\n### ðŸ“ˆ Coverage Report\n"
            SUMMARY+="**Minimum required:** 85%\n\n"
            SUMMARY+="![Coverage Badge](https://img.shields.io/badge/coverage-${LINES}%25-${COLOR}?style=flat)\n\n"
            SUMMARY+="| Metric | Coverage |\n"
            SUMMARY+="|--------|---------|\n"
            SUMMARY+="| Lines | ${LINES}% |\n"
            SUMMARY+="| Statements | ${STATEMENTS}% |\n"
            SUMMARY+="| Functions | ${FUNCTIONS}% |\n"
            SUMMARY+="| Branches | ${BRANCHES}% |\n"
          fi

          # Coverage per folder
          if [ -f "./tests/vitest/coverage/coverage-per-folder.md" ]; then
            SUMMARY+="\n### ðŸ—‚ Coverage per Folder\n"
            SUMMARY+="$(cat ./tests/vitest/coverage/coverage-per-folder.md)\n"
          fi

          # Post summary
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            # Comment on PR
            echo "$SUMMARY" | gh pr comment ${{ github.event.pull_request.number }} --body -
          else
            # Add to commit summary
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi